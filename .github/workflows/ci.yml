name: CI

on:
  pull_request: # when a pull request is opened
    branches: [main, master]
  push:
    branches: [main, master]

  # allows manual triggering of the workflow from the Actions tab
  workflow_dispatch:

jobs:
  # Job 1: Security scanning and testing
  scan_ruby:
    runs-on: ubuntu-latest

    # set default directory for all run commands
    defaults:
      run:
        working-directory: backend

    # steps to run
    steps:
      # step 1: get code from the repository
      - name: Checkout code
        uses: actions/checkout@v5

      # step 2: set up Ruby environment
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
          ruby-version: 3.4.7
          working-directory: backend

      # step 3: install dependencies
      - name: Install dependencies
        run: bundle install

      # step 4: set up database
      - name: Set up database
        run: |
          bin/rails db:create RAILS_ENV=test
          bin/rails db:schema:load RAILS_ENV=test
        env:
          RAILS_ENV: test

      # step 5: run all tests
      - name: Run tests
        run: bin/rails test
        env:
          RAILS_ENV: test

      # step 6: security scans
      - name: Scan for Rails security vulnerabilities
        run: bin/brakeman --no-pager

      # step 7: scan for vulnerable gems
      - name: Scan for vulnerable gems
        run: bin/bundler-audit

  # job 2: code style linting
  lint:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend

    env:
      RUBOCOP_CACHE_ROOT: tmp/rubocop

    steps:
      # step 1: get code from the repository
      - name: Checkout code
        uses: actions/checkout@v5

      # step 2: set up Ruby environment
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
          ruby-version: 3.4.7 # specify Ruby version to match mine
          working-directory: backend

      # 3: prepare RuboCop cache
      - name: Prepare RuboCop cache
        uses: actions/cache@v4
        env:
          DEPENDENCIES_HASH: ${{ hashFiles('.ruby-version', '**/.rubocop.yml', '**/.rubocop_todo.yml', 'Gemfile.lock') }}
        with:
          path: ${{ env.RUBOCOP_CACHE_ROOT }}
          key: rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-${{ github.ref_name == github.event.repository.default_branch && github.run_id || 'default' }}
          restore-keys: |
            rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-

      - name: Lint code for consistent style
        run: bin/rubocop -f github

# Job 3: Frontend tests
frontend:
  runs-on: ubuntu-latest

  defaults:
    run:
      working-directory: frontend

  steps:
    # step 1: get code from the repository
    - name: Checkout code
      uses: actions/checkout@v5

    # step 2: set up Node.js environment
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: "npm"
        cache-dependency-path: frontend/package-lock.json

    # step 3: install dependencies
    - name: Install dependencies
      run: npm ci

    # step 4: run frontend tests
    - name: Run frontend tests
      run: npm test

    # step 5: lint frontend
    - name: Lint frontend
      run: npm run lint

    # step 6: build frontend
    - name: Build frontend
      run: npm run build
